<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>MÁV Barcode Scanner Demo</title>
	<style>
		#result { margin-top: 1rem; display:block; }
		#video	{ max-width: 100%; display:none; }

		table, th, td {
			border: 1px solid;
		}
		th, td {
			padding: 5px;
		}
		table {
			border-collapse: collapse;
		}
		td.arrow {
			text-align: center;
		}

	</style>
</head>
<body>
	<h1>MÁV Barcode Scanner Demo</title></h1>
	<button id="startBtn">Start scanning</button>
	<button id="stopBtn"	style="display:none;">Stop</button>

	<video id="video" autoplay playsinline></video>
	<canvas id="canvas" style="display:none;"></canvas>

	<button id="retryBtn" style="display:none;">Try again</button>
	<div id="result" style="display:none;">
		<div id="ticketData">
			<h2>Ticket data</h3>
			<table>
				<tr>
					<th>Barcode</th>
					<th>Ticket medium</th>
					<th>Version</th>
					<th>Ticket id</th>
					<th>Price</th>
					<th>Issued at</th>
				</tr>
				<tr>
					<td id="barcode"></td>
					<td id="ticket_medium"></td>
					<td id="version"></td>
					<td id="ticket_id"></td>
					<td id="price"></td>
					<td id="issued_at"></td>
				</tr>
			</table>
		</div>

		<div id="passengerBlock" style="display:none;">
			<h2>Passenger</h3>
			<table>
				<tr>
					<th>Name</th>
					<th>Date of birth</th>
					<th>ID card number</th>
				</tr>
				<tr>
					<td id="name"></td>
					<td id="date_of_birth"></td>
					<td id="id_card_number"></td>
				</tr>
			</table>
		</div>

		<div id="tripBlock" style="display:none;">
			<h2>Trip data</h3>
			<table>
				<tr>
					<th></th>
					<th>Ticket kind</th>
					<th>Applied discounts</th>
					<th>Passengers</th>
					<th>Class</th>
				</tr>
				<tr>
					<td></td>
					<td id="trip_ticket_kind"></td>
					<td id="trip_applied_discounts"></td>
					<td id="trip_no_passengers"></td>
					<td id="trip_class"></td>
				</tr>
				<tr>
					<th>Route</th>
					<td id="trip_departure"></td>
					<td class="arrow"> &#8594;</td>
					<td id="trip_arrival"></td>
					<td id="trip_via"></td>
				</tr>
				<tr>
					<th>Valid</th>
					<td id="trip_valid_start"></td>
					<td class="arrow"> &#8594;</td>
					<td id="trip_valid_end"></td>
					<td></td>
				</tr>
			</table>
		</div>

		<div id="classUpgrade" style="display:none;">
			<h2>Class upgrade</h3>
			<table>
				<tr>
					<th></th>
					<th>Ticket kind</th>
					<th>Applied discounts</th>
					<th>Passengers</th>
					<th>Class</th>
				</tr>
				<tr>
					<td></td>
					<td id="clsu_ticket_kind"></td>
					<td id="clsu_applied_discounts"></td>
					<td id="clsu_no_passengers"></td>
					<td id="clsu_class"></td>
				</tr>
				<tr>
					<th>Route</th>
					<td id="clsu_departure"></td>
					<td class="arrow"> &#8594;</td>
					<td id="clsu_arrival"></td>
					<td></td>
				</tr>
				<tr>
					<td id="clsu_valid_start"></td>
					<td class="arrow"> &#8594;</td>
					<td id="clsu_valid_end"></td>
					<td></td>
				</tr>
			</table>
		</div>

		<div id="seatReservations" style="display:none;">
			<h2>Seat reservations</h3>
			<table id="seat1" style="display:none;">
				<tr>
					<th></th>
					<th>Ticket kind</th>
					<th>Issuer code</th>
					<th>Passengers</th>
					<th>Class</th>
					<th>Train</th>
					<th>Coach</th>
					<th>Seat</th>
				</tr>
				<tr>
					<td></td>
					<td id="seat1_ticket_kind"></td>
					<td id="seat1_rics_code"></td>
					<td id="seat1_no_passengers"></td>
					<td id="seat1_class"></td>
					<td id="seat1_train"></td>
					<td id="seat1_coach"></td>
					<td id="seat1_seat"></td>
				</tr>
				<tr>
					<th>Route</th>
					<td id="seat1_departure"></td>
					<td class="arrow"> &#8594;</td>
					<td id="seat1_arrival"></td>
					<td></td>
					<td colspan="3" id="seat1_travel_time"></td>
				</tr>
			</table>
			<table id="seat2" style="display:none;">
				<tr>
					<th></th>
					<th>Ticket kind</th>
					<th>Issuer code</th>
					<th>Passengers</th>
					<th>Class</th>
					<th>Train</th>
					<th>Coach</th>
					<th>Seat</th>
				</tr>
				<tr>
					<td></td>
					<td id="seat2_ticket_kind"></td>
					<td id="seat2_rics_code"></td>
					<td id="seat2_no_passengers"></td>
					<td id="seat2_class"></td>
					<td id="seat2_train"></td>
					<td id="seat2_coach"></td>
					<td id="seat2_seat"></td>
				</tr>
				<tr>
					<th>Route</th>
					<td id="seat2_departure"></td>
					<td class="arrow"> &#8594;</td>
					<td id="seat2_arrival"></td>
					<td></td>
					<td colspan="3" id="seat2_travel_time"></td>
				</tr>
			</table>
		</div>

		<div id="passBlock" style="display:none;">
			<h2>Pass</h3>
			<table>
				<tr>
					<th>Ticket kind</th>
					<th>Applied discounts?</th>
					<th>Applied discounts?</th>
					<th>Passengers</th>
				</tr>
				<tr>
					<td id="pass_ticket_kind"></td>
					<td id="pass_applied discounts1"></td>
					<td id="pass_applied discounts2"></td>
					<td id="pass_no_passengers"></td>
				</tr>
				<tr>
					<td id="pass_valid_start"></td>
					<td class="arrow"> &#8594;</td>
					<td id="pass_valid_end"></td>
					<td></td>
				</tr>
			</table>
		</div>
	</div>

	<script>
		const SCAN_URL = {{.}};

		const video     = document.getElementById('video');
		const canvas    = document.getElementById('canvas');
		const resultDiv = document.getElementById('result');
		const startBtn  = document.getElementById('startBtn');
		const stopBtn   = document.getElementById('stopBtn');
		const retryBtn  = document.getElementById('retryBtn');
		const width = 1280;
		const height = 960; 

		video.width = width;
		video.height = height;
		video.videoWidth = width;
		video.videoHeight = height;

		let scanInterval = null;
		let scanning = false;
		let uploading = false;

		async function startCamera() {
			const stream = await navigator.mediaDevices.getUserMedia({ video: true });
			video.srcObject = stream;
			video.onloadedmetadata = () => {
				video.play();
				video.style.display = 'block';
				startScanning();
			};
		}

		function startScanning() {
			if (scanInterval) clearInterval(scanInterval);
			scanning = true;
			scanInterval = setInterval(captureAndUpload, 1000);
		}

		function stopScanning() {
			scanning = false;
			if (scanInterval) {
				clearInterval(scanInterval);
				scanInterval = null;
			}
			if (video.srcObject) {
				video.srcObject.getTracks().forEach(t => t.stop());
				video.srcObject = null;
			}
		}

		function formatUnixTimestamp(unixTimestamp, minutes) {
			// Convert Unix timestamp from seconds to milliseconds
			const date = new Date((unixTimestamp + minutes * 60) * 1000);

			// Build the formatted string
			const year = date.getUTCFullYear(); // Get year
			const month = (date.getUTCMonth() + 1).toString().padStart(2, '0'); // Get month (0-11, thus add 1), format as two digits
			const day = date.getUTCDate().toString().padStart(2, '0'); // Get day (1-31), format as two digits
			const hour = date.getUTCHours().toString().padStart(2, '0'); // Get hours in 24-hr format, format as two digits
			const minute = date.getUTCMinutes().toString().padStart(2, '0'); // Get minutes, format as two digits

			// Format as "YYYY-MM-DD HH:MM"
			return `${year}-${month}-${day} ${hour}:${minute}`;
		}


		function renderResults(data) {
			const p = data.result.payload;
			const h = p.header;

			document.getElementById("barcode").textContent = data.barcode;
			document.getElementById("ticket_medium").textContent = h.ticket_medium.name || h.ticket_medium.tag;
			document.getElementById("version").textContent = data.result.envelope.version;
			document.getElementById("ticket_id").textContent = h.ticket_id;
			document.getElementById("price").textContent = h.price;
			document.getElementById("issued_at").textContent = formatUnixTimestamp(h.issued_at.seconds_since_1970, 0);

			if (h.flags.person_block_present) {
				document.getElementById("passengerBlock").style.display = 'block';

				const pb = p.person_block;

				document.getElementById("name").textContent = pb.name;
				document.getElementById("date_of_birth").textContent = pb.birth_date.year + `-` + pb.birth_date.month + `-` + pb.birth_date.day;
				document.getElementById("id_card_number").textContent = pb.id_card_number;
			} else {
				document.getElementById("passengerBlock").style.display = 'none';
			}

			if (h.flags.trip_block_present) {
				document.getElementById("tripBlock").style.display = 'block';

				const tb = p.trip_block;

				document.getElementById("trip_ticket_kind").textContent = tb.ticket_kind.name || tb.ticket_kind.tag;
				document.getElementById("trip_applied_discounts").textContent = tb.applied_discounts.name || tb.applied_discounts.tag;
				document.getElementById("trip_no_passengers").textContent = tb.num_passengers;
				document.getElementById("trip_class").textContent = tb.class;
				document.getElementById("trip_departure").textContent = tb.departure_station.name || tb.departure_station.id;
				document.getElementById("trip_arrival").textContent = tb.destination_station.name || tb.destination_station.id;
				if (tb && Array.isArray(tb["via_stations"])) {
					document.getElementById("trip_via").textContent = tb["via_stations"]
						.map(elem => elem.name || elem.id)
						.join(' - ');
				}

				document.getElementById("trip_valid_start").textContent = formatUnixTimestamp(tb.valid_start_at.seconds_since_1970, 0);
				document.getElementById("trip_valid_end").textContent = formatUnixTimestamp(tb.valid_start_at.seconds_since_1970, tb.valid_interval.minutes);

			} else {
				document.getElementById("tripBlock").style.display = 'none';
			}

			if (h.num_class_upgrade_blocks > 0) {
				document.getElementById("classUpgrade").style.display = 'block';

				// FIXME handle more than one?
				const cb = p.class_upgrade_blocks[0];

				document.getElementById("clsu_ticket_kind").textContent = cb.ticket_kind.name || cb.ticket_kind.tag;
				document.getElementById("clsu_applied_discounts").textContent = cb.applied_discounts.name || cb.applied_discounts.tag;
				document.getElementById("clsu_no_passengers").textContent = cb.num_passengers;
				document.getElementById("clsu_class").textContent = cb.class;
				document.getElementById("clsu_departure").textContent = cb.departure_station.name || cb.departure_station.id;
				document.getElementById("clsu_arrival").textContent = cb.destination_station.name || cb.destination_station.id;

				document.getElementById("clsu_valid_start").textContent = formatUnixTimestamp(cb.valid_start_at.seconds_since_1970, 0);
				document.getElementById("clsu_valid_end").textContent = formatUnixTimestamp(cb.valid_start_at.seconds_since_1970, cb.valid_interval.minutes);

			} else {
				document.getElementById("classUpgrade").style.display = 'none';
			}

			if (h.num_seat_reservation_blocks > 0) {
				document.getElementById("seatReservations").style.display = 'block';
				document.getElementById("seat1").style.display = 'inline-block';

				const s1 = p.seat_reservation_blocks[0];

				document.getElementById("seat1_ticket_kind").textContent = s1.ticket_kind.name || s1.ticket_kind.tag;
				document.getElementById("seat1_rics_code").textContent = s1.rics_code;
				document.getElementById("seat1_no_passengers").textContent = s1.num_passengers;
				document.getElementById("seat1_class").textContent = s1.class;
				document.getElementById("seat1_departure").textContent = s1.departure_station.name || s1.departure_station.id;
				document.getElementById("seat1_arrival").textContent = s1.destination_station.name || s1.destination_station.id;

				document.getElementById("seat1_train").textContent = s1.train_number;
				document.getElementById("seat1_coach").textContent = s1.car_number;
				document.getElementById("seat1_seat").textContent = s1.seat_number;
				document.getElementById("seat1_travel_time").textContent = formatUnixTimestamp(s1.travel_time.seconds_since_1970, 0);

			} else {
				document.getElementById("seatReservations").style.display = 'none';
				document.getElementById("seat1").style.display = 'none';
			}
			if (h.num_seat_reservation_blocks > 1) {
				document.getElementById("seat2").style.display = 'inline-block';

				// FIXME handle more than two?
				const s2 = p.seat_reservation_blocks[1];

				document.getElementById("seat2_ticket_kind").textContent = s2.ticket_kind.name || s2.ticket_kind.tag;
				document.getElementById("seat2_rics_code").textContent = s2.rics_code;
				document.getElementById("seat2_no_passengers").textContent = s2.num_passengers;
				document.getElementById("seat2_class").textContent = s2.class;
				document.getElementById("seat2_departure").textContent = s2.departure_station.name || s2.departure_station.id;
				document.getElementById("seat2_arrival").textContent = s2.destination_station.name || s2.destination_station.id;

				document.getElementById("seat2_train").textContent = s2.train_number;
				document.getElementById("seat2_coach").textContent = s2.car_number;
				document.getElementById("seat2_seat").textContent = s2.seat_number;
				document.getElementById("seat2_travel_time").textContent = formatUnixTimestamp(s2.travel_time.seconds_since_1970, 0);

			} else {
				document.getElementById("seat2").style.display = 'none';
			}

			if (h.num_pass_blocks > 0) {
				document.getElementById("passBlock").style.display = 'block';

				// FIXME handle more than one?
				const pb = p.pass_blocks[0];

				document.getElementById("pass_ticket_kind").textContent = pb.ticket_kind.name || pb.ticket_kind.tag;
				document.getElementById("pass_applied_discounts1").textContent = pb.applied_discounts_1.name || pb.applied_discounts_1.tag;
				document.getElementById("pass_applied_discounts2").textContent = pb.applied_discounts_2.name || pb.applied_discounts_2.tag;
				document.getElementById("pass_no_passengers").textContent = pb.num_passengers;

				document.getElementById("pass_valid_start").textContent = formatUnixTimestamp(pb.valid_start_at.seconds_since_1970, 0);
				document.getElementById("pass_valid_end").textContent = formatUnixTimestamp(pb.valid_start_at.seconds_since_1970, pb.valid_interval.minutes);

			} else {
				document.getElementById("passBlock").style.display = 'none';
			}

		}

		async function captureAndUpload() {
			if (!scanning || uploading || !video.videoWidth) return;
			uploading = true;

			canvas.width = width;
			canvas.height = height;
			const ctx = canvas.getContext('2d');
			ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

			canvas.toBlob(async (blob) => {
				try {
					const formData = new FormData();
					formData.append('image', blob, 'frame.jpg');

					const res = await fetch(SCAN_URL, { method: 'POST', body: formData });
					const data = await res.json();

					// If user pressed Stop while this request was in flight, ignore result
					if (!scanning) return;

					if (data.success) {
						stopScanning();
						video.style.display = 'none';
						stopBtn.style.display = 'none';

						renderResults(data);

						//resultDiv.textContent = JSON.stringify(data);
						resultDiv.style.display = 'block';
						retryBtn.style.display = 'inline-block';
					}
				} catch (e) {
					console.error('Upload error:', e);
				} finally {
					uploading = false;
				}
		 }, 'image/jpeg');
		}

		// UI event handlers
		startBtn.addEventListener('click', () => {
			resultDiv.style.display = 'none';
			retryBtn.style.display = 'none';
			startBtn.style.display = 'none';
			stopBtn.style.display = 'inline-block';
			startCamera().catch(err => {
				console.error('Camera error:', err);
				startBtn.style.display = 'inline-block';
				stopBtn.style.display = 'none';
			});
		});

		stopBtn.addEventListener('click', () => {
			stopScanning();
			video.style.display = 'none';
			stopBtn.style.display = 'none';
			startBtn.style.display = 'inline-block';
			resultDiv.style.display = 'none';
			retryBtn.style.display = 'none';
		});

		retryBtn.addEventListener('click', () => {
			resultDiv.style.display = 'none';
			retryBtn.style.display = 'none';
			startBtn.style.display = 'none';
			stopBtn.style.display = 'inline-block';
			startCamera().catch(err => {
				console.error('Camera error:', err);
				startBtn.style.display = 'inline-block';
				stopBtn.style.display = 'none';
			});
		});
	</script>
</body>
</html>


